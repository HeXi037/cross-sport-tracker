# Adds healthchecks without touching docker-compose.unraid.yml
services:
  backend:
    # backend is a Python image, so Python is guaranteed available
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python - <<'PY'\nimport urllib.request, sys\ntry:\n  with urllib.request.urlopen('http://127.0.0.1:8000/api/healthz', timeout=2) as r:\n    sys.exit(0 if r.status==200 else 1)\nexcept Exception:\n  sys.exit(1)\nPY",
        ]
      interval: 15s
      timeout: 3s
      retries: 5
      start_period: 20s

  web:
    # web is a Node image; use Node to probe /
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"require('http').get('http://127.0.0.1:3000/',r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))\"",
        ]
      interval: 15s
      timeout: 3s
      retries: 5
      start_period: 30s

  db_backup:
    # postgres image includes pg_isready; make host configurable
    environment:
      - POSTGRES_HOST=${POSTGRES_HOST:-postgresql16}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -h $${POSTGRES_HOST:-postgresql16} -U $${PGUSER} -d $${PGDATABASE} -t 2",
        ]
      interval: 60s
      timeout: 5s
      retries: 5
      start_period: 30s

# End of healthcheck configuration
